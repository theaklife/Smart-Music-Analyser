const suggestionsDB = {
  Phonk: [
    { title: "NEON BLADE", artist: "MoonDeity", link: "https://open.spotify.com/track/0iUrxveyNUBfj0cqjYEijt" },
    { title: "Dream Space", artist: "DVRST", link: "https://open.spotify.com/track/4wHkfOTO5XpTrVn1bHxR18" },
    { title: "Slapper - Fast & Furious: Drift Tape/Phonk Vol 1", artist: "DVRST", link: "https://open.spotify.com/track/4Zf7vu8xsZeqOvel5fqyEK" },
    { title: "Murder In My Mind", artist: "Kordhell", link: "https://open.spotify.com/track/6qyS9qBy0mEk3qYaH8mPss" },
    { title: "SLAVA FUNK", artist: "MVSTERIOUS", link: "https://open.spotify.com/track/55YYhNqfMTIpPulNc0lLme" },
    { title: "METAMORPHOSIS", artist: "INTERWORLD", link: "https://open.spotify.com/track/2ksyzVfU0WJoBpu8otr4pz" },
    { title: "krushed!", artist: "$werve", link: "https://open.spotify.com/track/3iQ1B1jF370iZEaJUIs3eJ" },
    { title: "Solitude", artist: "SHXDWBLNDNSS", link: "https://open.spotify.com/track/2IUQGMmrVvumcZYXi69vHP" }
  ],
  Trap: [
    { title: "Goosebumps-Remix", artist: "Travis Scott", link: "https://open.spotify.com/track/5uEYRdEIh9Bo4fpjDd4Na9" },
    { title: "Paris", artist: "$uicideboy$", link: "https://open.spotify.com/track/6tO5bxNnMuh1c3cziSpecA" },
    { title: "REDLIGHT", artist: "NGHTMRE", link: "https://open.spotify.com/track/4Joy4odtE1z0AX32uWoAQn" },
    { title: "CRUSH", artist: "Bellorum", link: "https://open.spotify.com/track/3l5KAvmMw41kdoU4lZZHVJ" },
    { title: "Devil", artist: "Barren Gates", link: "https://open.spotify.com/track/3lj59hy6FrRDyYNo8Onuud" },
    { title: "Seizure", artist: "The FifthGuys", link: "https://open.spotify.com/track/5wqPpv0nROPAMg7h7R0wA8" }
  ],
  Sad: [
    { title: "Past Lives", artist: "Martin Arteta", link: "https://open.spotify.com/track/3NPWH2UbMjch2vnS7qMFGM" },
    { title: "In The Stars", artist: "Benson Boone", link: "https://open.spotify.com/track/1ei3hzQmrgealgRKFxIcWn" },
    { title: "My Stupid Heart", artist: "Walk off the Earth", link: "https://open.spotify.com/track/3UZDl7g2r84o1b5marUjfK" },
    { title: "Aadat", artist: "Atif Aslam", link: "https://open.spotify.com/track/5VrLz2NUTLbPzgjuVOjxUx" },
    { title: "Stay A Little Longer", artist: "Anushka Ahahaney", link: "https://open.spotify.com/track/38OB4wNN5nyKqYU1tvJi2A" },
    { title: "Banjaara", artist: "Mohammed Irfan", link: "https://open.spotify.com/track/2S6N9pbnkhQRyAx80HmF79" },
    { title: "Hamari Adhuri Kahani(title Track)", artist: "Jeet Gannguli", link: "https://open.spotify.com/track/3HiobOOpSpMsi95WBKPBYk" },
    { title: "My Heart Into Your Arms", artist: "GoldRush", link: "https://open.spotify.com/track/1yAVk873pGNA3ie66PBvIY" },
    { title: "Arcade", artist: "Duncan Laurence", link: "https://open.spotify.com/track/4Ld4kbKo1eOzToQ0P8JA0V" }
  ],
  Love: [
    { title: "Apna Bana Le", artist: "Sachin-Jigar", link: "https://open.spotify.com/track/5bQ6oDLqvw8tywmnSmwEyL" },
    { title: "Infinity", artist: "Jaymes Young", link: "https://open.spotify.com/track/1SOClUWhOi8vHZYMz3GluK" },
    { title: "Maan Meri Jaan", artist: "King", link: "https://open.spotify.com/track/1418IuVKQPTYqt7QNJ9RXN" },
    { title: "Tere Liye", artist: "Atif Aslam", link: "https://open.spotify.com/track/0fCQRUbk8LIQTdQYGNtGyv" },
    { title: "Tu Zaroori - Male", artist: "Shaarib Toshi", link: "https://open.spotify.com/track/0CrArphWykD5XyIebBbPci" },
    { title: "Let The Eyes Talk", artist: "King", link: "https://open.spotify.com/track/1IzBTrGD5citT79A2PXQTL" }
  ],
  Pop: [
    { title: "Timeless (feat Playboi Carti)", artist: "The Weeknd", link: "https://open.spotify.com/track/0FIDCNYYjNvPVimz5icugS" },
    { title: "After Hours", artist: "The Weeknd", link: "https://open.spotify.com/track/2p8IUWQDrpjuFltbdgLOag" },
    { title: "Starboy", artist: "The Weeknd", link: "https://open.spotify.com/track/7MXVkk9YMctZqd1Srtv4MB" },
    { title: "Mask Off", artist: "Future", link: "https://open.spotify.com/track/0VgkVdmE4gld66l8iyGjgx" },
    { title: "Heat Waves", artist: "Glass Animals", link: "https://open.spotify.com/track/3USxtqRwSYz57Ewm6wWRMp" },
    { title: "Close Eyes", artist: "DVRST", link: "https://open.spotify.com/track/3CLSHJv5aUROAN2vfOyCOh" }
  ],
  Lofi: [
    { title: "Saiyaaya - Lofi Mix", artist: "Sohail Sen", link: "https://open.spotify.com/track/3kZOn4HmRRZo4ac24nK1L7" },
    { title: "zaroorat", artist: "Mitraz", link: "https://open.spotify.com/track/4qxkxgoJaPVGsam45iTdcF" },
    { title: "Samjhawan", artist: "Jawad Ahmad", link: "https://open.spotify.com/track/4LO5DjN6Tp3UkUvgESuy2t" },
    { title: "Ilahi Lofi Mix", artist: "Pritam", link: "https://open.spotify.com/track/0GucA3qLWxJU6Peffg3yHD" },
    { title: "Tune Jo Na Kaha - Lofi Mix", artist: "Pritam", link: "https://open.spotify.com/track/1A2C3BQQ5CivJEqjKpXMTl" },
    { title: "Tum Tak - Lofi Flip", artist: "Deepanshu Ruhela", link: "https://open.spotify.com/track/4DvAqLQNC0kW3XT2EE69cY" }
  ],
  Rock: [
    { title: "Smells Like Teen Spirit", artist: "Nirvana", link: "https://open.spotify.com/track/4CeeEOM32jQcH3eN9Q2dGj" },
    { title: "Enter Sandman - Remastered 2021", artist: "Metallica", link: "https://open.spotify.com/track/3DwQ7AH3xGD9h65ezslm6q" },
    { title: "In the End", artist: "Linkin Park", link: "https://open.spotify.com/track/5DXGHZ3QDh0FcLXPMWTv9U" },
    { title: "Immigrant Song - Remaster", artist: "Led Zeppelin", link: "https://open.spotify.com/track/78lgmZwycJ3nzsdgmPPGNx" },
    { title: "Crazy Train", artist: "Ozzy Osbourne", link: "https://open.spotify.com/track/7ACxUo21jtTHzy7ZEV56vU" },
    { title: "Stereo Hearts(feat. Adam Levine)", artist: "Gym Class Heroes", link: "https://open.spotify.com/track/0qOnSQQF0yzuPWsXrQ9paz" }
  ],
  Indie: [
    { title: "Paro", artist: "Aditya rikhari", link: "https://open.spotify.com/track/6nRGPf5tpeJtKpXZO5cgIT" },
    { title: "Mahiya", artist: "Muneeb Haque", link: "https://open.spotify.com/track/6vWr92wJy69TKj3ieTirvf" },
    { title: "Over You", artist: "Sukriti Kakar", link: "https://open.spotify.com/track/0UyZAe6XSZvUMbecCHjssx" },
    { title: "Jo Tum Mere Ho", artist: "Anuv Jain", link: "https://open.spotify.com/track/0eCajpR75pDW0r64U6hP2x" },
    { title: "Husn", artist: "Anuv Jain", link: "https://open.spotify.com/track/0TL0LFcwIBF5eX7arDIKxY" },
    { title: "Teri Yaad", artist: "Aditya rikhari", link: "https://open.spotify.com/track/3uUAbrwsttRpv2kfAvAUN9" }
  ]
};

document.getElementById('audioUpload').addEventListener('change', async function(e) {
  const file = e.target.files[0];
  if (!file) return;

  // Display file info
  showFileInfo(file);

  try {
    // Try to read metadata first
    const metadata = await readAudioMetadata(file);
    const metadataGenre = metadata.genre || detectGenreFromFilename(file.name);
    const userSelectedGenre = document.getElementById('genreSelect').value;
    
    // Priority: User selection > Metadata > Filename detection
    const finalGenre = userSelectedGenre || metadataGenre || detectGenreFromFilename(file.name);
    
    // Update the dropdown to show the detected genre
    if (metadataGenre && !userSelectedGenre) {
      document.getElementById('genreSelect').value = metadataGenre;
    }
    
    showSuggestions(finalGenre, metadata);
  } catch (error) {
    console.error("Error reading metadata:", error);
    // Fallback to filename detection
    const filenameGenre = detectGenreFromFilename(file.name);
    const finalGenre = document.getElementById('genreSelect').value || filenameGenre;
    
    if (filenameGenre && !document.getElementById('genreSelect').value) {
      document.getElementById('genreSelect').value = filenameGenre;
    }
    
    showSuggestions(finalGenre);
  }
});

document.getElementById('genreSelect').addEventListener('change', function() {
  const selectedGenre = this.value;
  if (selectedGenre) {
    showSuggestions(selectedGenre);
  }
});

function showFileInfo(file) {
  const fileInfoDiv = document.getElementById('fileInfo');
  fileInfoDiv.innerHTML = `
    <p><strong>File:</strong> ${file.name}</p>
    <p><strong>Type:</strong> ${file.type || 'Unknown'}</p>
    <p><strong>Size:</strong> ${(file.size / (1024 * 1024)).toFixed(2)} MB</p>
  `;
  fileInfoDiv.style.display = 'block';
}

async function readAudioMetadata(file) {
  return new Promise((resolve, reject) => {
    jsmediatags.read(file, {
      onSuccess: function(tag) {
        const tags = tag.tags;
        resolve({
          title: tags.title || 'Unknown',
          artist: tags.artist || 'Unknown',
          genre: tags.genre ? tags.genre.split(/[,/]/)[0].trim() : null,
          year: tags.year || null
        });
      },
      onError: function(error) {
        reject(error);
      }
    });
  });
}

function detectGenreFromFilename(filename) {
  const name = filename.toLowerCase();
  if (name.includes("phonk")) return "Phonk";
  if (name.includes("trap")) return "Trap";
  if (name.includes("sad")) return "Sad";
  if (name.includes("lofi")) return "Lofi";
  if (name.includes("rock")) return "Rock";
  if (name.includes("indie")) return "Indie";
  if (name.includes("pop")) return "Pop";
  if (name.includes("love")) return "Love";
  return null;
}

function showSuggestions(genre, metadata = null) {
  const resultsDiv = document.getElementById('results');
  resultsDiv.innerHTML = '';

  if (!genre || !suggestionsDB[genre]) {
    resultsDiv.innerHTML = `<p class="no-results">No suggestions found for this genre.</p>`;
    return;
  }

  resultsDiv.innerHTML += `
    <div class="mood-header">
      <h2><span>ðŸŽµ</span> ${genre} Recommendations</h2>
      ${metadata ? `<p class="detected-from">Detected from: ${metadata.genre ? 'File Metadata' : 'Filename'}</p>` : ''}
    </div>
  `;

  // Show all songs for the genre
  suggestionsDB[genre].forEach(song => {
    const trackId = extractSpotifyId(song.link);
    resultsDiv.innerHTML += `
      <div class="song-card">
        <div class="song-info">
          <div class="song-title">${song.title}</div>
          <div class="song-artist">${song.artist}</div>
        </div>
        <iframe src="https://open.spotify.com/embed/track/${trackId}?utm_source=generator&theme=0" 
                class="spotify-embed" 
                height="152" 
                frameborder="0" 
                allowfullscreen="" 
                allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" 
                loading="lazy">
        </iframe>
        <a href="${song.link}" target="_blank" class="song-link">Open in Spotify â†’</a>
      </div>
    `;
  });
}

function extractSpotifyId(url) {
  const match = url.match(/track\/([a-zA-Z0-9]+)/);
  return match ? match[1] : '';
}